{% extends 'base.html' %}

{% block title %}Profile - {{ full_name }}{% endblock %}

{% block content %}
<div class="container py-4">

    <!-- Top Right Buttons -->
    <div class="d-flex justify-content-end mb-3 gap-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.history.back();">
            <i class="fas fa-arrow-left"></i> Back
        </button>
        <a class="btn btn-sm btn-outline-danger" href="{% url 'role_redirect' %}">
            <i class="fas fa-times"></i> Cancel
        </a>
    </div>

    <!-- Profile Header -->
    <div class="card mb-4 shadow-sm border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="card-body" style="color: white;">
            <div class="row">
                <div class="col-md-3 text-center mb-3">
                    {% if profile_pic %}
                        <div style="position: relative; display: inline-block;">
                            <img src="{{ profile_pic }}" alt="Profile picture of {{ full_name }}"
                                 class="rounded-circle img-fluid shadow"
                                 style="max-width: 200px; cursor: pointer; border: 4px solid white; transition: transform 0.2s;"
                                 onclick="showProfilePhotoModal(this.src)"
                                 data-bs-toggle="tooltip"
                                 title="Click to view full size">
                            <small class="text-center d-block mt-2" style="color: rgba(255,255,255,0.9);">Click to enlarge</small>
                        </div>
                    {% else %}
                        <div class="rounded-circle bg-light text-dark d-flex align-items-center justify-content-center mx-auto shadow"
                             aria-label="Profile initial"
                             style="width: 200px; height: 200px; font-size: 48px; font-weight: bold; border: 4px solid white;">
                            {{ full_name|make_list|first|upper }}
                        </div>
                    {% endif %}

                    {% if profile.user == request.user %}
                        <a href="{% url 'edit_profile' %}" class="btn btn-light mt-3 w-100">
                            <i class="fas fa-edit"></i> Edit Profile
                        </a>
                    {% endif %}
                </div>

                <div class="col-md-9">
                    <h2 class="fw-bold" style="color: white; margin-bottom: 0.5rem;">{{ full_name }}</h2>
                    
                    <div class="mb-3">
                        <span class="badge bg-light text-dark px-3 py-2" style="font-size: 0.95rem;">
                            <i class="fas fa-user-circle"></i> {{ profile.get_role_display }}
                        </span>
                        {% if profile.role == 'student' %}
                        <span class="badge bg-success px-3 py-2" style="font-size: 0.95rem; margin-left: 0.5rem;">
                            <i class="fas fa-check-circle"></i> Active Student
                        </span>
                        {% endif %}
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6" style="color: rgba(255,255,255,0.95);">
                            <p class="mb-2"><strong><i class="fas fa-envelope"></i> Email:</strong></p>
                            <p style="margin-left: 1.5rem; color: white;">{{ email }}</p>
                            
                            <p class="mb-2" style="margin-top: 1rem;"><strong><i class="fas fa-phone"></i> Phone:</strong></p>
                            <p style="margin-left: 1.5rem; color: white;">{{ phone|default:'Not provided' }}</p>
                        </div>

                        <div class="col-md-6" style="color: rgba(255,255,255,0.95);">
                            <p class="mb-2"><strong><i class="fas fa-building"></i> Department:</strong></p>
                            <p style="margin-left: 1.5rem; color: white;">{{ department|default:'Not specified' }}</p>
                            
                            {% if profile.role == 'student' %}
                            <p class="mb-2" style="margin-top: 1rem;"><strong><i class="fas fa-id-card"></i> Roll Number:</strong></p>
                            <p style="margin-left: 1.5rem; color: white;">{{ roll_number|default:'Not specified' }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STUDENT VIEW -->
    {% if profile.role == 'student' %}
    <div class="row mb-4">
        <!-- Quick Stats -->
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center">
                            <h3 class="text-primary fw-bold">{{ total_courses }}</h3>
                            <p class="text-muted mb-0"><i class="fas fa-book"></i> Courses Enrolled</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center">
                            <h3 class="text-success fw-bold">{{ attendance_rate }}%</h3>
                            <p class="text-muted mb-0"><i class="fas fa-calendar-check"></i> Attendance</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center">
                            <h3 class="text-warning fw-bold">{{ avg_marks }}</h3>
                            <p class="text-muted mb-0"><i class="fas fa-star"></i> Avg Marks</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center">
                            <h3 class="text-info fw-bold">{{ student_class|default:"N/A" }}</h3>
                            <p class="text-muted mb-0"><i class="fas fa-graduation-cap"></i> Class</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Course Performance Detailed -->
        <div class="col-md-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title fw-bold mb-3">
                        <i class="fas fa-chart-bar"></i> Course Performance Details
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="fas fa-book"></i> Course</th>
                                    <th class="text-center"><i class="fas fa-star"></i> Avg Marks</th>
                                    <th class="text-center"><i class="fas fa-calendar-check"></i> Attendance</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in course_performance %}
                                <tr>
                                    <td>
                                        <strong>{{ course.course.name }}</strong>
                                        <br>
                                        <small class="text-muted">Code: {{ course.course.code }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge {% if course.avg_marks >= 75 %}bg-success{% elif course.avg_marks >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ course.avg_marks }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                            <div class="progress" style="height: 25px;">
                                            <div class="progress-bar {% if course.attendance >= 75 %}bg-success{% elif course.attendance >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 role="progressbar" 
                                                 aria-valuenow="{{ course.attendance }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100"
                                                 data-progress-width="{{ course.attendance }}">
                                                {{ course.attendance }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% if course.attendance >= 75 and course.avg_marks >= 60 %}
                                        <span class="badge bg-success"><i class="fas fa-check-circle"></i> Excellent</span>
                                        {% elif course.attendance >= 60 and course.avg_marks >= 50 %}
                                        <span class="badge bg-info"><i class="fas fa-thumbs-up"></i> Good</span>
                                        {% else %}
                                        <span class="badge bg-warning"><i class="fas fa-exclamation-triangle"></i> Needs Work</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox"></i> No courses enrolled yet
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% elif profile.role == 'teacher' %}
    <!-- TEACHER VIEW -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h3 class="text-primary fw-bold">{{ total_courses }}</h3>
                    <p class="text-muted"><i class="fas fa-book"></i> Total Courses</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h3 class="text-success fw-bold">{{ total_students }}</h3>
                    <p class="text-muted"><i class="fas fa-users"></i> Total Students</p>
                </div>
            </div>
        </div>

        <div class="col-md-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title fw-bold mb-3">
                        <i class="fas fa-chart-bar"></i> Course Statistics
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="fas fa-book"></i> Course</th>
                                    <th class="text-center"><i class="fas fa-users"></i> Students</th>
                                    <th class="text-center"><i class="fas fa-calendar-check"></i> Attendance Rate</th>
                                    <th class="text-center"><i class="fas fa-star"></i> Average Marks</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in course_stats %}
                                <tr>
                                    <td>
                                        <strong>{{ course.course.name }}</strong>
                                        <br>
                                        <small class="text-muted">Code: {{ course.course.code }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-primary">{{ course.students }}</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="progress" style="height: 25px;">
                                            <div class="progress-bar bg-success" 
                                                 role="progressbar" 
                                                 aria-valuenow="{{ course.attendance_rate }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100"
                                                 data-progress-width="{{ course.attendance_rate }}">
                                                {{ course.attendance_rate }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge {% if course.avg_marks >= 75 %}bg-success{% elif course.avg_marks >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ course.avg_marks }}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox"></i> No courses assigned
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% endif %}

    <!-- Footer Back Buttons According to Role -->
    <div class="row mt-4">
        <div class="col-12">
            {% if profile.role == 'teacher' %}
                <a href="{% url 'teacher_dashboard' %}" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i> Back to Teacher Dashboard
                </a>
            {% elif profile.role == 'student' %}
                <a href="{% url 'student_dashboard' %}" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i> Back to Student Dashboard
                </a>
            {% elif profile.role == 'superadmin' %}
                <a href="{% url 'admin_dashboard' %}" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i> Back to Admin Dashboard
                </a>
            {% else %}
                <a href="{% url 'role_redirect' %}" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            {% endif %}
        </div>
    </div>

</div>

<!-- Profile Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ full_name }} - Profile Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalPhotoImage" src="" alt="Profile photo" class="img-fluid rounded" style="max-height: 80vh;">
            </div>
        </div>
    </div>
</div>

<script>
function showProfilePhotoModal(photoSrc) {
    document.getElementById('modalPhotoImage').src = photoSrc;
    var photoModal = new bootstrap.Modal(document.getElementById('photoModal'));
    photoModal.show();
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    // Apply progress widths stored in data attributes to avoid template tags inside CSS
    document.querySelectorAll('[data-progress-width]').forEach(function(el) {
        var val = el.getAttribute('data-progress-width') || 0;
        // ensure numeric value
        var n = parseFloat(val) || 0;
        el.style.width = n + '%';
    });
});
</script>
{% endblock %}