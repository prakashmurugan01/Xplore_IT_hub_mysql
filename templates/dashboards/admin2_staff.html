{% extends 'base.html' %}

{% block title %}Staff Management{% endblock %}

{% block extra_css %}
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    --danger-gradient: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
    --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    --hover-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
  }

  body {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
  }

  .staff-header {
    background: var(--primary-gradient);
    color: white;
    padding: 2rem;
    border-radius: 20px;
    margin-bottom: 2rem;
    box-shadow: var(--card-shadow);
    position: relative;
    overflow: hidden;
  }

  .staff-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 300px;
    height: 300px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
  }

  .stats-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .stats-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--primary-gradient);
  }

  .stats-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--hover-shadow);
  }

  .stats-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  .search-container {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: var(--card-shadow);
    margin-bottom: 2rem;
  }

  .search-input {
    border: 2px solid #e0e7ff;
    border-radius: 12px;
    padding: 0.75rem 1rem 0.75rem 3rem;
    transition: all 0.3s ease;
  }

  .search-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
  }

  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #667eea;
  }

  .staff-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
  }

  .staff-card:hover {
    transform: translateX(5px);
    box-shadow: var(--hover-shadow);
    border-left-color: #667eea;
  }

  .staff-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--primary-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.5rem;
  }

  .badge-custom {
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
  }

  .badge-position {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .btn-gradient-primary {
    background: var(--primary-gradient);
    border: none;
    color: white;
    padding: 0.6rem 1.5rem;
    border-radius: 10px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-gradient-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    color: white;
  }

  .btn-gradient-success {
    background: var(--success-gradient);
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-gradient-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(17, 153, 142, 0.3);
    color: white;
  }

  .modal-content {
    border-radius: 20px;
    border: none;
    overflow: hidden;
  }

  .modal-header {
    background: var(--primary-gradient);
    color: white;
    border: none;
    padding: 1.5rem;
  }

  .modal-header .btn-close {
    filter: brightness(0) invert(1);
  }

  .salary-history {
    background: #f8f9ff;
    border-radius: 10px;
    padding: 1rem;
    margin-top: 1rem;
  }

  .salary-item {
    padding: 0.75rem;
    background: white;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
  }

  .salary-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .filter-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .filter-tab {
    padding: 0.5rem 1.5rem;
    border: 2px solid #e0e7ff;
    border-radius: 25px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
  }

  .filter-tab:hover {
    border-color: #667eea;
    transform: translateY(-2px);
  }

  .filter-tab.active {
    background: var(--primary-gradient);
    color: white;
    border-color: transparent;
  }

  .action-btn {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    border: none;
    margin: 0 0.25rem;
  }

  .action-btn:hover {
    transform: scale(1.1);
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #6b7280;
  }

  .empty-state-icon {
    font-size: 4rem;
    opacity: 0.3;
    margin-bottom: 1rem;
  }

  .view-toggle {
    display: flex;
    gap: 0.5rem;
    background: white;
    padding: 0.5rem;
    border-radius: 10px;
  }

  .view-toggle-btn {
    padding: 0.5rem 1rem;
    border: none;
    background: transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .view-toggle-btn.active {
    background: var(--primary-gradient);
    color: white;
  }

  .table-view {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: var(--card-shadow);
    overflow: hidden;
  }

  .table-modern {
    margin: 0;
  }

  .table-modern thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .table-modern thead th {
    border: none;
    padding: 1rem;
    font-weight: 600;
  }

  .table-modern tbody tr {
    transition: all 0.2s ease;
  }

  .table-modern tbody tr:hover {
    background: #f8f9ff;
    transform: scale(1.01);
  }

  .quick-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in {
    animation: fadeIn 0.5s ease;
  }

  .export-btn {
    background: white;
    border: 2px solid #667eea;
    color: #667eea;
    padding: 0.6rem 1.5rem;
    border-radius: 10px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .export-btn:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
  }

  .notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">
  <!-- Header Section -->
  <div class="staff-header fade-in">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="mb-2">üë• Staff Management</h1>
        <p class="mb-0 opacity-75">Manage your team efficiently and track payments</p>
      </div>
      <div class="d-flex gap-2">
        {% include 'dashboards/_dashboard_action_buttons.html' %}
        <button class="btn btn-light export-btn" id="exportData">
          üìä Export
        </button>
        <button class="btn btn-gradient-primary" id="openAddStaff">
          ‚ú® Add Staff
        </button>
        <a class="btn btn-light export-btn" href="{% url 'admin2_financial' %}">
          üí∞ Finance
        </a>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="quick-stats fade-in">
    <div class="stats-card">
      <div class="stats-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        üë•
      </div>
      <h3 class="mb-1" id="totalStaffCount">{{ staff|length }}</h3>
      <p class="text-muted mb-0">Total Staff</p>
    </div>
    
    <div class="stats-card">
      <div class="stats-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
        üë®‚Äçüè´
      </div>
      <h3 class="mb-1" id="teachersCount">0</h3>
      <p class="text-muted mb-0">Teachers</p>
    </div>
    
    <div class="stats-card">
      <div class="stats-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        üíµ
      </div>
      <h3 class="mb-1" id="totalPaidAmount">$0</h3>
      <p class="text-muted mb-0">Total Paid</p>
    </div>
    
    <div class="stats-card">
      <div class="stats-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
        üìÖ
      </div>
      <h3 class="mb-1" id="thisMonthPayments">$0</h3>
      <p class="text-muted mb-0">This Month</p>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="search-container fade-in">
    <div class="row align-items-center">
      <div class="col-md-6">
        <div class="position-relative">
          <span class="search-icon">üîç</span>
          <input id="staffSearch" class="form-control search-input" placeholder="Search by name, username, or position..." />
        </div>
      </div>
      <div class="col-md-6 text-end">
        <div class="view-toggle d-inline-flex">
          <button class="view-toggle-btn active" data-view="cards">
            <span>üìã Cards</span>
          </button>
          <button class="view-toggle-btn" data-view="table">
            <span>üìä Table</span>
          </button>
        </div>
      </div>
    </div>
    
    <div class="filter-tabs mt-3">
      <div class="filter-tab active" data-filter="all">All Staff</div>
      <div class="filter-tab" data-filter="Teacher">Teachers</div>
      <div class="filter-tab" data-filter="Admin">Admin</div>
      <div class="filter-tab" data-filter="Support">Support</div>
      <div class="filter-tab" data-filter="recent">Recent Payments</div>
    </div>
  </div>

  <!-- Cards View -->
  <div id="cardsView" class="fade-in">
    {% for s in staff %}
    <div class="staff-card" data-position="{{ s.position }}" data-username="{{ s.profile.user.username }}" data-staff-id="{{ s.id }}">
      <div class="row align-items-center">
        <div class="col-auto">
          <div class="staff-avatar">
            {{ s.profile.user.username|slice:":2"|upper }}
          </div>
        </div>
        <div class="col">
          <h5 class="mb-1">{{ s.profile.user.get_full_name|default:s.profile.user.username }}</h5>
          <div class="d-flex align-items-center gap-2">
            <span class="badge-custom badge-position">{{ s.position }}</span>
            <small class="text-muted">@{{ s.profile.user.username }}</small>
            <small class="text-muted">‚Ä¢ Joined {{ s.date_joined|date:"M d, Y" }}</small>
          </div>
        </div>
        <div class="col-auto">
          <div class="d-flex gap-2">
            <button class="action-btn btn btn-outline-primary" data-action="edit" data-id="{{ s.id }}" title="Edit">
              ‚úèÔ∏è
            </button>
            <button class="action-btn btn btn-outline-danger" data-action="remove" data-id="{{ s.id }}" title="Remove">
              üóëÔ∏è
            </button>
            <button class="btn-gradient-success" data-action="pay" data-id="{{ s.id }}" data-username="{{ s.profile.user.username }}">
              üí∞ Pay
            </button>
            <button class="action-btn btn btn-outline-secondary" data-action="toggle-history" data-id="{{ s.id }}" title="View History">
              üìú
            </button>
          </div>
        </div>
      </div>
      
      <div class="salary-history mt-3" id="history-{{ s.id }}" style="display: none;">
        <h6 class="mb-3">üíµ Salary History</h6>
        {% with rows=s.salaryrecord_set.all|slice:":5" %}
          {% if rows %}
            {% for r in rows %}
            <div class="salary-item">
              <div>
                <strong>{{ r.amount }}</strong>
                <small class="text-muted d-block">{{ r.paid_on|date:"M d, Y" }}</small>
              </div>
              <div class="text-end">
                {% if r.notes %}
                <small class="text-muted">{{ r.notes }}</small>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          {% else %}
            <p class="text-muted text-center mb-0">No payment records yet</p>
          {% endif %}
        {% endwith %}
      </div>
    </div>
    {% empty %}
    <div class="empty-state">
      <div class="empty-state-icon">üì≠</div>
      <h4>No Staff Members Yet</h4>
      <p>Add your first staff member to get started</p>
    </div>
    {% endfor %}
  </div>

  <!-- Table View (Hidden by default) -->
  <div id="tableView" class="table-view" style="display: none;">
    <table class="table table-modern">
      <thead>
        <tr>
          <th>Staff Member</th>
          <th>Position</th>
          <th>Date Joined</th>
          <th>Recent Payment</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody id="tableViewBody">
        {% for s in staff %}
        <tr data-position="{{ s.position }}" data-username="{{ s.profile.user.username }}">
          <td>
            <div class="d-flex align-items-center gap-2">
              <div class="staff-avatar" style="width: 40px; height: 40px; font-size: 1rem;">
                {{ s.profile.user.username|slice:":2"|upper }}
              </div>
              <div>
                <strong>{{ s.profile.user.get_full_name|default:s.profile.user.username }}</strong>
                <small class="text-muted d-block">@{{ s.profile.user.username }}</small>
              </div>
            </div>
          </td>
          <td><span class="badge-custom badge-position">{{ s.position }}</span></td>
          <td>{{ s.date_joined|date:"M d, Y" }}</td>
          <td>
            {% with latest=s.salaryrecord_set.first %}
              {% if latest %}
                <strong>{{ latest.amount }}</strong><br>
                <small class="text-muted">{{ latest.paid_on|date:"M d, Y" }}</small>
              {% else %}
                <span class="text-muted">No payments</span>
              {% endif %}
            {% endwith %}
          </td>
          <td class="text-center">
            <button class="action-btn btn btn-outline-primary" data-action="edit" data-id="{{ s.id }}">‚úèÔ∏è</button>
            <button class="action-btn btn btn-outline-danger" data-action="remove" data-id="{{ s.id }}">üóëÔ∏è</button>
            <button class="btn-gradient-success btn-sm" data-action="pay" data-id="{{ s.id }}" data-username="{{ s.profile.user.username }}">üí∞ Pay</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Available Teachers Section -->
  <div class="mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>üéì Available Teachers</h4>
      <span class="badge bg-secondary">{{ teachers|length }} available</span>
    </div>
    
    <div class="row">
      {% for t in teachers %}
      <div class="col-md-6 col-lg-4 mb-3">
        <div class="staff-card">
          <div class="d-flex align-items-center mb-3">
            <div class="staff-avatar me-3" style="width: 50px; height: 50px;">
              {{ t.user.username|slice:":2"|upper }}
            </div>
            <div>
              <h6 class="mb-0">{{ t.user.get_full_name }}</h6>
              <small class="text-muted">@{{ t.user.username }}</small>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm flex-grow-1" data-action="view-teacher" data-id="{{ t.id }}">
              üëÅÔ∏è View
            </button>
            <form method="post" action="{% url 'admin2_add_staff' t.id %}" class="flex-grow-1">
              {% csrf_token %}
              <input type="hidden" name="position" value="Teacher" />
              <button class="btn-gradient-success w-100 btn-sm" type="submit">
                ‚ûï Add as Staff
              </button>
            </form>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="col-12">
        <div class="empty-state">
          <div class="empty-state-icon">‚úÖ</div>
          <h5>All Teachers Added</h5>
          <p class="text-muted">All available teachers are already staff members</p>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Add Staff Modal -->
  <div class="modal fade" id="addStaffModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="addStaffForm" method="post">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">‚ú® Add New Staff Member</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Select Teacher</label>
              <select name="profile_id" id="addStaffSelect" class="form-select">
                <option value="" disabled selected>Select a teacher</option>
                {% if teachers %}
                  {% for t in teachers %}
                    <option value="{{ t.id }}">{{ t.user.username }} ‚Äî {{ t.user.get_full_name }}</option>
                  {% endfor %}
                {% else %}
                  <option value="" disabled>No teachers available</option>
                {% endif %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Position</label>
              <select name="position" class="form-select">
                <option value="Teacher">Teacher</option>
                <option value="Admin">Admin</option>
                <option value="Support">Support Staff</option>
                <option value="Manager">Manager</option>
                <option value="Coordinator">Coordinator</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn-gradient-primary">Add Staff Member</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Pay Modal -->
  <div class="modal fade" id="payModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="payForm" method="post" action="{% url 'admin2_add_salary' %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">üí∞ Record Payment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="staff_id" id="payStaffId" />
            <div class="mb-3">
              <label class="form-label">Staff Member</label>
              <input class="form-control" id="payStaffName" readonly style="background: #f8f9ff;" />
            </div>
            <div class="mb-3">
              <label class="form-label">Amount</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input name="amount" type="number" step="0.01" class="form-control" required placeholder="0.00" />
              </div>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="is_advance" id="payIsAdvance">
              <label class="form-check-label" for="payIsAdvance">
                Mark as advance payment
              </label>
            </div>
            <div class="mb-3">
              <label class="form-label">Notes (Optional)</label>
              <textarea name="notes" class="form-control" rows="3" placeholder="Add any additional notes about this payment..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn-gradient-success">üíµ Record Payment</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
 (function(){
  'use strict';

  // Helper to read CSRF token from cookie (safer than embedding template variable into JS)
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }

  // Initialize stats
  function calculateStats() {
    const staffCards = document.querySelectorAll('.staff-card[data-position]');
    let teachersCount = 0;
    let totalPaid = 0;
    let thisMonthPayments = 0;
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();

    staffCards.forEach(card => {
      const position = card.getAttribute('data-position');
      if (position === 'Teacher') teachersCount++;

      // Calculate payments from salary history
      const salaryItems = card.querySelectorAll('.salary-item');
      salaryItems.forEach(item => {
        const amountText = item.querySelector('strong')?.textContent || '0';
        const amount = parseFloat(amountText.replace(/[^0-9.-]+/g, ''));
        totalPaid += amount;

        // Check if payment is from this month
        const dateText = item.querySelector('.text-muted')?.textContent || '';
        const paymentDate = new Date(dateText);
        if (paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear) {
          thisMonthPayments += amount;
        }
      });
    });

    document.getElementById('teachersCount').textContent = teachersCount;
    document.getElementById('totalPaidAmount').textContent = '$' + totalPaid.toFixed(2);
    document.getElementById('thisMonthPayments').textContent = '$' + thisMonthPayments.toFixed(2);
  }

  calculateStats();

  // Search functionality
  const staffSearch = document.getElementById('staffSearch');
  const cardsView = document.querySelectorAll('#cardsView .staff-card[data-position]');
  const tableRows = document.querySelectorAll('#tableViewBody tr[data-position]');

  if (staffSearch) {
    staffSearch.addEventListener('input', function(){
      const query = this.value.toLowerCase();
      
      cardsView.forEach(card => {
        const username = card.getAttribute('data-username').toLowerCase();
        const position = card.getAttribute('data-position').toLowerCase();
        const fullText = card.textContent.toLowerCase();
        const matches = username.includes(query) || position.includes(query) || fullText.includes(query);
        card.style.display = matches ? '' : 'none';
      });

      tableRows.forEach(row => {
        const username = row.getAttribute('data-username').toLowerCase();
        const position = row.getAttribute('data-position').toLowerCase();
        const fullText = row.textContent.toLowerCase();
        const matches = username.includes(query) || position.includes(query) || fullText.includes(query);
        row.style.display = matches ? '' : 'none';
      });
    });
  }

  // Filter tabs
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.addEventListener('click', function(){
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      const filter = this.getAttribute('data-filter');
      
      cardsView.forEach(card => {
        if (filter === 'all') {
          card.style.display = '';
        } else if (filter === 'recent') {
          const hasHistory = card.querySelector('.salary-item');
          card.style.display = hasHistory ? '' : 'none';
        } else {
          const position = card.getAttribute('data-position');
          card.style.display = position === filter ? '' : 'none';
        }
      });

      tableRows.forEach(row => {
        if (filter === 'all') {
          row.style.display = '';
        } else if (filter === 'recent') {
          const hasPayment = row.querySelector('td:nth-child(4) strong');
          row.style.display = hasPayment ? '' : 'none';
        } else {
          const position = row.getAttribute('data-position');
          row.style.display = position === filter ? '' : 'none';
        }
      });
    });
  });

  // View toggle
  document.querySelectorAll('.view-toggle-btn').forEach(btn => {
    btn.addEventListener('click', function(){
      document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      const view = this.getAttribute('data-view');
      document.getElementById('cardsView').style.display = view === 'cards' ? '' : 'none';
      document.getElementById('tableView').style.display = view === 'table' ? '' : 'none';
    });
  });

  // Toggle salary history
  document.querySelectorAll('[data-action="toggle-history"]').forEach(btn => {
    btn.addEventListener('click', function(){
      const id = this.getAttribute('data-id');
      const history = document.getElementById('history-' + id);
      if (history) {
        history.style.display = history.style.display === 'none' ? '' : 'none';
        this.textContent = history.style.display === 'none' ? 'üìú' : 'üìñ';
      }
    });
  });

  // Open add staff modal
  document.getElementById('openAddStaff')?.addEventListener('click', function(){
    const addModal = new bootstrap.Modal(document.getElementById('addStaffModal'));
    addModal.show();
  });

  // Wire pay buttons
  document.querySelectorAll('[data-action="pay"]').forEach(btn => {
    btn.addEventListener('click', function(){
      const id = this.getAttribute('data-id');
      const username = this.getAttribute('data-username');
      document.getElementById('payStaffId').value = id;
      document.getElementById('payStaffName').value = username;
      const payModal = new bootstrap.Modal(document.getElementById('payModal'));
      payModal.show();
    });
  });

  // Add staff form submission
  const addForm = document.getElementById('addStaffForm');
  if (addForm){
    addForm.addEventListener('submit', function(e){
      // Use the modal form itself (it already contains the CSRF token input)
      const sel = document.getElementById('addStaffSelect');
      const profileId = sel ? sel.value : '';
      if (!profileId) {
        // prevent empty submission and prompt user
        e.preventDefault();
        alert('Please select a teacher to add as staff.');
        return;
      }
      const url = `{% url 'admin2_add_staff' 0 %}`.replace('/0/', '/' + profileId + '/');
      // set the form action to the resolved URL and allow normal submission so Django's CSRF input is used
      addForm.action = url;
      // let the browser submit the form normally
    });
  }

  // Export functionality
  document.getElementById('exportData')?.addEventListener('click', function(){
    const data = [];
    document.querySelectorAll('#cardsView .staff-card[data-position]').forEach(card => {
      const username = card.getAttribute('data-username');
      const position = card.getAttribute('data-position');
      const dateText = card.textContent.match(/Joined (.*?)(?=üíµ|$)/)?.[1]?.trim() || 'N/A';
      
      const salaries = [];
      card.querySelectorAll('.salary-item').forEach(item => {
        const amount = item.querySelector('strong')?.textContent || '0';
        const date = item.querySelector('.text-muted')?.textContent || '';
        salaries.push(`${date}: ${amount}`);
      });
      
      data.push({
        Username: username,
        Position: position,
        'Date Joined': dateText,
        'Payment History': salaries.join('; ') || 'None'
      });
    });

    const csv = [
      Object.keys(data[0]).join(','),
      ...data.map(row => Object.values(row).map(v => `"${v}"`).join(','))
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `staff_data_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
  });

  // Remove staff confirmation
  document.querySelectorAll('[data-action="remove"]').forEach(btn => {
    btn.addEventListener('click', function(){
      if (confirm('Are you sure you want to remove this staff member? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '{% url "admin2_remove_staff" 0 %}'.replace('/0/', '/' + this.getAttribute('data-id') + '/');
        
  const csrf = document.createElement('input');
  csrf.type = 'hidden';
  csrf.name = 'csrfmiddlewaretoken';
  csrf.value = getCookie('csrftoken') || '{{ csrf_token }}';
  form.appendChild(csrf);
        
        document.body.appendChild(form);
        form.submit();
      }
    });
  });

  // Smooth scroll animations
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateY(0)';
      }
    });
  }, { threshold: 0.1 });

  document.querySelectorAll('.staff-card, .stats-card').forEach(el => {
    el.style.opacity = '0';
    el.style.transform = 'translateY(20px)';
    el.style.transition = 'all 0.5s ease';
    observer.observe(el);
  });
})();
</script>
{% endblock %},