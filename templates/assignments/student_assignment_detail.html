{% extends 'base.html' %}
{% load static %}

{% block title %}Assignment: {{ assignment.title }}{% endblock %}

{% block content %}
<main class="container py-4">

  <a href="{% url 'student_assignments' %}" class="btn btn-link mb-3">
    &larr; Back to assignments
  </a>

  <div class="d-flex gap-2 mb-3">
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.history.back();">Back</button>
    <a class="btn btn-sm btn-outline-danger" href="{% url 'role_redirect' %}">Cancel</a>
  </div>

  <div class="card shadow-sm border-0" style="border-radius: 12px;">
    <div class="card-body p-4">

      <!-- Header Section -->
      <div class="mb-4">
        <h3 class="fw-bold mb-2" style="color: var(--primary, #667eea);">{{ assignment.title }}</h3>

        <div class="text-muted mb-3 d-flex gap-3 flex-wrap">
          <span><i class="bi bi-book me-2"></i>Course: <strong>{{ assignment.course.name }}</strong></span>
          {% if assignment.due_date %}
            <span><i class="bi bi-calendar-event me-2"></i>Due: <strong>{{ assignment.due_date|date:'M d, Y' }}</strong></span>
          {% else %}
            <span><i class="bi bi-calendar-event me-2"></i><em>No due date</em></span>
          {% endif %}
        </div>
      </div>

      <!-- Assignment details -->
      <div class="mb-4 p-4 bg-light rounded" style="border-left: 4px solid var(--primary, #667eea);">
        <h5 class="fw-bold mb-3">
          <i class="bi bi-file-text me-2"></i>Assignment Details
        </h5>

        {% if assignment.body %}
          <div class="mt-2">{{ assignment.body|safe }}</div>
        {% else %}
          <div class="mt-2">{{ assignment.description|linebreaks }}</div>
        {% endif %}
      </div>

      <!-- Files -->
      {% if assignment.attachments.exists %}
        <div class="mb-4">
          <h5 class="fw-bold mb-3">
            <i class="bi bi-paperclip me-2"></i>Attached Files
          </h5>
          <div class="list-group">

            {% for attachment in assignment.attachments.all %}
              <a href="{{ attachment.file.url }}" 
                 class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                 download style="border-radius: 8px; margin-bottom: 8px;">
                <div>
                  <i class="bi bi-file-earmark text-primary me-2"></i>
                  <strong>{{ attachment.file.name }}</strong>
                </div>

                <small class="text-muted">
                  {{ attachment.uploaded_at|date:'M d, Y H:i' }}
                </small>
              </a>
            {% endfor %}

          </div>
        </div>
      {% endif %}

      <!-- MCQ Questions Section -->
      {% if assignment.question_set.exists %}
      <div class="mb-4 p-4 rounded" style="background-color: rgba(102, 126, 234, 0.05); border: 2px solid var(--primary, #667eea);">
        <h5 class="fw-bold mb-3" style="color: var(--primary, #667eea);">
          <i class="bi bi-question-circle me-2"></i>Multiple Choice Questions
        </h5>

        <div id="mcqContainer">
          {% for question in assignment.question_set.all %}
          <div class="card mb-3 shadow-sm" style="border-radius: 10px; border: 1px solid #e0e0e0;">
            <div class="card-body p-3">
              <!-- Question Header -->
              <div class="d-flex justify-content-between align-items-start mb-3">
                <h6 class="fw-bold mb-0">
                  <span class="badge bg-primary" style="border-radius: 50%; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center;">
                    {{ forloop.counter }}
                  </span>
                  <span class="ms-2">{{ question.text }}</span>
                </h6>
              </div>

              <!-- MCQ Options -->
              <div class="mcq-options">
                {% if question.option_set.exists %}
                  {% for option in question.option_set.all %}
                  <div class="form-check mb-2">
                    <input class="form-check-input mcq-option" 
                           type="radio" 
                           name="question_{{ question.id }}" 
                           id="option_{{ option.id }}"
                           value="{{ option.id }}"
                           data-question-id="{{ question.id }}"
                           data-is-correct="{% if option.is_correct %}true{% else %}false{% endif %}"
                           style="border-radius: 4px;">
                    <label class="form-check-label" for="option_{{ option.id }}" style="margin-left: 0.5rem; cursor: pointer;">
                      <strong>{{ option.text }}</strong>
                    </label>
                  </div>
                  {% endfor %}
                {% else %}
                  <p class="text-muted"><em>No options available</em></p>
                {% endif %}
              </div>

              <!-- Question Feedback -->
              <div class="mt-3 pt-3 border-top" style="display: none;" class="question-feedback-{{ question.id }}">
                <small class="d-block mb-2" style="color: var(--primary, #667eea);">
                  <i class="bi bi-info-circle me-1"></i><strong>Feedback:</strong>
                </small>
                <small class="text-muted d-block">
                  {% if question.explanation %}
                    {{ question.explanation }}
                  {% else %}
                    Select an option to see feedback.
                  {% endif %}
                </small>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- MCQ Summary -->
        <div class="alert alert-info mt-3" role="alert" style="border-radius: 8px;">
          <strong><i class="bi bi-graph-up me-2"></i>Quiz Progress:</strong>
          <div class="progress mt-2" style="height: 20px; border-radius: 4px;">
            <div id="mcqProgress" class="progress-bar" role="progressbar" style="width: 0%; background: linear-gradient(90deg, var(--primary), var(--secondary));" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
              0/{{ assignment.question_set.count }} answered
            </div>
          </div>
        </div>

        <!-- MCQ Buttons -->
        <div class="d-flex gap-2 mt-3 flex-wrap">
          <button type="button" class="btn btn-outline-primary" onclick="submitMCQAnswers()" style="border-radius: 6px;">
            <i class="bi bi-check-circle me-1"></i>Submit Answers
          </button>
          <button type="button" class="btn btn-outline-secondary" onclick="clearMCQAnswers()" style="border-radius: 6px;">
            <i class="bi bi-arrow-clockwise me-1"></i>Clear All
          </button>
          <button type="button" class="btn btn-outline-info" onclick="showMCQResults()" style="border-radius: 6px;">
            <i class="bi bi-eye me-1"></i>View Results
          </button>
        </div>
      </div>
      {% endif %}

      <hr>

      <!-- Student submission -->
      <h5 class="fw-bold mb-3">
        <i class="bi bi-pencil-square me-2"></i>Your Submission
      </h5>

      {% if submission %}
        <div class="mb-3 p-3 bg-success bg-opacity-10 rounded" style="border-left: 4px solid #28a745;">
          <small class="text-muted d-block mb-2">
            <i class="bi bi-check-circle me-1" style="color: #28a745;"></i>
            <strong>Submitted at:</strong> {{ submission.submission_date|date:'M d, Y H:i' }}
          </small>
          {% if submission.text %}
            <div class="mt-2 p-2 bg-light rounded">
              {{ submission.text|linebreaks }}
            </div>
          {% endif %}

          {% if submission.file %}
            <div class="mt-2">
              <a href="{{ submission.file.url }}" class="btn btn-sm btn-outline-secondary" download style="border-radius: 6px;">
                <i class="bi bi-download me-1"></i>Download submitted file
              </a>
            </div>
          {% endif %}

          <div class="mt-2">
            <strong>Marks:</strong>
            {% if submission.marks_obtained is not None %}
            <span class="badge {% if submission.marks_obtained >= 70 %}bg-success{% elif submission.marks_obtained >= 50 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
              {{ submission.marks_obtained }}
            </span>
            {% else %}
            <span class="badge bg-secondary">Not graded</span>
            {% endif %}
          </div>

          {% if submission.feedback %}
            <div class="mt-2 p-2 bg-light rounded">
              <strong><i class="bi bi-chat-left me-1"></i>Teacher Feedback:</strong><br>
              <small class="text-muted">{{ submission.feedback|linebreaks }}</small>
            </div>
          {% endif %}
        </div>

      {% else %}
        <p class="text-muted"><i class="bi bi-info-circle me-1"></i>You haven't submitted anything yet.</p>
      {% endif %}

      <!-- Submission Form -->
      <form method="post" enctype="multipart/form-data" class="mt-4">
        {% csrf_token %}

        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="bi bi-pencil me-1"></i>Submit Answer (Text)
          </label>
          <textarea name="submission_text" class="form-control" rows="5"
            placeholder="Write your answer here..." style="border-radius: 8px;"></textarea>
          <small class="text-muted">Share your complete solution or explanation.</small>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="bi bi-file-earmark-arrow-up me-1"></i>Upload File (optional)
          </label>
          <input type="file" name="submission_file" class="form-control" style="border-radius: 8px;" />
          <small class="text-muted">Max: 10MB (PDF, DOC, DOCX, ZIP)</small>
        </div>

        <button type="submit" class="btn btn-primary btn-lg" style="border-radius: 8px; width: 100%;">
          <i class="bi bi-cloud-upload me-2"></i>Submit Assignment
        </button>
      </form>

    </div>
  </div>
</main>

<script>
  // MCQ Functionality
  function updateMCQProgress() {
    const totalQuestions = document.querySelectorAll('[name^="question_"]').length / document.querySelectorAll('[name^="question_"]').length;
    const answeredQuestions = document.querySelectorAll('[name^="question_"]:checked').length;
    const totalCount = Math.max(...Array.from(document.querySelectorAll('[name^="question_"]')).map(el => parseInt(el.name.split('_')[1])), 0);
    
    const progress = totalCount > 0 ? Math.round((answeredQuestions / totalCount) * 100) : 0;
    const progressBar = document.getElementById('mcqProgress');
    if (progressBar) {
      progressBar.style.width = progress + '%';
      progressBar.textContent = answeredQuestions + '/' + totalCount + ' answered';
    }
  }

  function submitMCQAnswers() {
    const answers = {};
    let answeredCount = 0;
    
    document.querySelectorAll('[name^="question_"]:checked').forEach(el => {
      answers[el.getAttribute('data-question-id')] = el.value;
      answeredCount++;
    });

    if (answeredCount === 0) {
      alert('Please answer at least one question before submitting.');
      return;
    }

    alert('MCQ Answers submitted!\nYou answered: ' + answeredCount + ' questions');
    console.log('MCQ Answers:', answers);
  }

  function clearMCQAnswers() {
    if (confirm('Clear all MCQ answers?')) {
      document.querySelectorAll('[name^="question_"]:checked').forEach(el => el.checked = false);
      updateMCQProgress();
      alert('All answers cleared!');
    }
  }

  function showMCQResults() {
    let correctCount = 0;
    const totalQuestions = document.querySelectorAll('[id^="option_"]').length;
    
    document.querySelectorAll('[name^="question_"]:checked').forEach(el => {
      if (el.getAttribute('data-is-correct') === 'true') {
        correctCount++;
      }
    });

    const answeredCount = document.querySelectorAll('[name^="question_"]:checked').length;
    const percentage = answeredCount > 0 ? Math.round((correctCount / answeredCount) * 100) : 0;

    alert('MCQ Results:\n\n' +
          'Correct Answers: ' + correctCount + '\n' +
          'Total Answered: ' + answeredCount + '\n' +
          'Score: ' + percentage + '%');
  }

  // Initialize progress tracking
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[name^="question_"]').forEach(el => {
      el.addEventListener('change', updateMCQProgress);
    });
    updateMCQProgress();
  });
</script>

{% endblock %}
